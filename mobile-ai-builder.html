<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Scenario Builder Mobile</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            min-height: 100vh;
            padding: 10px;
            color: #e0e0e0;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        
        .header {
            background: linear-gradient(135deg, #2d2d2d 0%, #404040 100%);
            color: white;
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .content {
            padding: 20px;
            background: rgba(20, 20, 20, 0.5);
        }
        
        .step {
            display: none;
            animation: slideIn 0.3s ease-out;
        }
        
        .step.active {
            display: block;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #e0e0e0;
            font-size: 16px;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 16px;
            background: rgba(40, 40, 40, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
            -webkit-appearance: none;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            background: rgba(50, 50, 50, 0.9);
        }
        
        input::placeholder, textarea::placeholder {
            color: #888;
        }
        
        textarea {
            height: 120px;
            resize: vertical;
        }
        
        .btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #4b5563 0%, #6b7280 100%);
            box-shadow: 0 4px 12px rgba(75, 85, 99, 0.3);
            margin-right: 10px;
            width: calc(50% - 5px);
        }
        
        .btn-primary {
            width: calc(50% - 5px);
        }
        
        .progress {
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        .success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #22c55e;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: #f59e0b;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .feedback-item {
            background: rgba(40, 40, 40, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #6366f1;
        }
        
        .feedback-item h4 {
            margin-bottom: 8px;
            color: #e0e0e0;
        }
        
        .feedback-item p {
            margin-bottom: 8px;
            color: #b0b0b0;
            font-size: 14px;
        }
        
        .key-input {
            margin-top: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 40px 20px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e1e5e9;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .examples {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .examples h3 {
            margin-bottom: 10px;
            color: #495057;
            font-size: 16px;
        }
        
        .example {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin: 8px 0;
            cursor: pointer;
            border: 1px solid #dee2e6;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .example:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .step-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e1e5e9;
            margin: 0 4px;
            transition: all 0.3s;
        }
        
        .step-dot.active {
            background: #6366f1;
            transform: scale(1.2);
        }
        
        .step-dot.completed {
            background: #22c55e;
        }
        
        @media (max-width: 480px) {
            .container {
                margin: 5px;
                border-radius: 12px;
            }
            
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .content {
                padding: 15px;
            }
            
            .btn-secondary, .btn-primary {
                width: 100%;
                margin: 5px 0;
            }
        }
        
        /* microphone button */
        .mic-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            margin-left: 8px;
            cursor: pointer;
            transition: background 0.2s;
            vertical-align: middle;
            color: #e0e0e0;
        }
        
        .mic-btn.active {
            background: #6366f1;
            color: #fff;
            box-shadow: 0 0 12px rgba(99, 102, 241, 0.5);
        }
        
        /* connected apps */
        .connected-apps {
            background: rgba(40, 40, 40, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
            font-size: 14px;
            color: #b0b0b0;
        }
        
        /* logs */
        .logs {
            max-height: 120px;
            overflow-y: auto;
            font-size: 12px;
            margin-top: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 8px;
            background: rgba(20, 20, 20, 0.8);
            display: none; /* hidden until first log arrives */
        }
        
        .log-item {
            margin-bottom: 2px;
        }
        
        .log-item.success { color: #22c55e; }
        .log-item.error { color: #ef4444; }
        .log-item.info { color: #94a3b8; }
        
        /* Chat interface */
        .chat-container {
            background: rgba(30, 30, 30, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        
        .chat-message {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .chat-message.user {
            background: rgba(99, 102, 241, 0.1);
        }
        
        .chat-message.claude {
            background: rgba(139, 92, 246, 0.1);
        }
        
        .chat-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .chat-avatar.user {
            background: #6366f1;
        }
        
        .chat-avatar.claude {
            background: #8b5cf6;
        }
        
        .chat-content {
            flex: 1;
            color: #e0e0e0;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .chat-input {
            display: flex;
            gap: 10px;
            padding: 12px;
            background: rgba(40, 40, 40, 0.5);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .chat-input input {
            margin: 0;
        }
        
        .chat-input button {
            width: auto;
            padding: 12px 20px;
            margin: 0;
        }
        
        /* API Setup Guide */
        .api-setup-guide {
            background: rgba(40, 40, 40, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin: 15px 0;
        }
        
        .api-step {
            margin: 12px 0;
            padding: 12px;
            background: rgba(50, 50, 50, 0.5);
            border-radius: 8px;
            border-left: 3px solid #6366f1;
        }
        
        .api-step h5 {
            color: #6366f1;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .api-step p {
            color: #b0b0b0;
            font-size: 13px;
            margin: 4px 0;
        }
        
        .api-step a {
            color: #6366f1;
            text-decoration: none;
            font-weight: 500;
        }
        
        .api-step a:hover {
            color: #8b5cf6;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 AI Scenario Builder</h1>
            <p>Create Make.com automations with AI assistance</p>
        </div>
        
        <div class="content">
            <div class="step-indicator">
                <div class="step-dot active" data-step="1"></div>
                <div class="step-dot" data-step="2"></div>
                <div class="step-dot" data-step="3"></div>
                <div class="step-dot" data-step="4"></div>
            </div>
            
            <div class="progress">
                <div class="progress-bar" style="width: 25%"></div>
            </div>
            
            <div id="logContainer" class="logs"></div>
            
            <!-- Step 1: Configuration -->
            <div class="step active" id="step1">
                <h2>⚙️ Configuration</h2>
                <div class="form-group">
                    <label for="webhookUrl">Make.com Webhook URL:</label>
                    <input type="url" id="webhookUrl" placeholder="https://hook.us1.make.com/..." value="https://hook.us2.make.com/l4hnd2qdxuivmeix2jrwmva6c495zlwe" required>
                    <small style="color: #666; font-size: 12px;">Get this from your Make.com scenario Module 1</small>
                </div>
                <div id="connectedApps" class="connected-apps"></div>
                <div class="form-group">
                    <label>🤖 Ask Claude for Help</label>
                    <button class="btn btn-secondary" onclick="toggleChat()">Chat with Claude Assistant</button>
                    <div id="chatContainer" class="chat-container">
                        <div id="chatMessages"></div>
                        <div class="chat-input">
                            <input type="text" id="chatInput" placeholder="Ask Claude about Make.com, API setup, or anything else..." onkeypress="handleChatKeyPress(event)">
                            <button onclick="sendChatMessage()">Send</button>
                        </div>
                    </div>
                </div>
                <button class="btn" onclick="nextStep()">Continue</button>
            </div>
            
            <!-- Step 2: Automation Request -->
            <div class="step" id="step2">
                <h2>📝 Describe Your Automation</h2>
                
                <div class="form-group">
                    <label for="description">What do you want to automate?
                        <button type="button" class="mic-btn" onclick="startSpeechRecognition(event)">🎤</button>
                    </label>
                    <textarea id="description" placeholder="Describe your automation in detail..." required></textarea>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="prevStep()">Back</button>
                    <button class="btn btn-primary" onclick="generateScenario()">Generate</button>
                </div>
            </div>
            
            <!-- Step 3: Processing -->
            <div class="step" id="step3">
                <div class="loading">
                    <div class="spinner"></div>
                    <h3>🤖 AI is creating your scenario...</h3>
                    <p>This may take 10-30 seconds</p>
                </div>
            </div>
            
            <!-- Step 4: Results & Feedback -->
            <div class="step" id="step4">
                <h2>✅ Scenario Generated!</h2>
                <div id="results"></div>
                <div id="feedback-section"></div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="startOver()">Start Over</button>
                    <button class="btn btn-primary" onclick="downloadBlueprint()">Download</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let scenarioData = null;
        let requiredKeys = [];
        let logs = [];
        
        function updateProgress() {
            const progress = (currentStep / 4) * 100;
            document.querySelector('.progress-bar').style.width = progress + '%';
            
            // Update step indicators
            document.querySelectorAll('.step-dot').forEach((dot, index) => {
                const stepNum = index + 1;
                dot.classList.remove('active', 'completed');
                
                if (stepNum < currentStep) {
                    dot.classList.add('completed');
                } else if (stepNum === currentStep) {
                    dot.classList.add('active');
                }
            });
        }
        
        function showStep(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');
            currentStep = step;
            updateProgress();
        }
        
        function nextStep() {
            if (currentStep === 1) {
                const webhookUrl = document.getElementById('webhookUrl').value;
                if (!webhookUrl || !webhookUrl.includes('hook.') || !webhookUrl.includes('make.com')) {
                    alert('Please enter a valid Make.com webhook URL');
                    return;
                }
            }
            
            if (currentStep < 4) {
                showStep(currentStep + 1);
            }
        }
        
        function prevStep() {
            if (currentStep > 1) {
                showStep(currentStep - 1);
            }
        }
        
        function setExample(text) {
            document.getElementById('description').value = text;
        }
        
        async function generateScenario() {
            const webhookUrl = document.getElementById('webhookUrl').value;
            const description = document.getElementById('description').value;
            
            if (!description.trim()) {
                alert('Please describe what you want to automate');
                return;
            }
            
            showStep(3); // Show loading
            
            try {
                addLog('Posting description to webhook', 'info');
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        description: description,
                        callback_url: window.location.origin + '/callback'
                    })
                });
                
                if (response.ok) {
                    addLog('Webhook accepted request – awaiting AI generation', 'success');
                    // Simulate AI processing time
                    setTimeout(() => {
                        simulateScenarioResponse(description);
                    }, 3000);
                } else {
                    addLog('Webhook returned HTTP ' + response.status, 'error');
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
            } catch (error) {
                addLog('Scenario generation failed: ' + error.message, 'error');
                showError('Failed to generate scenario: ' + error.message);
                showStep(2);
            }
        }
        
        function simulateScenarioResponse(description) {
            const requiredServices = detectRequiredServices(description);
            const blueprint = generateRealisticBlueprint(description, requiredServices);
            
            scenarioData = {
                blueprint: blueprint,
                setup_instructions: generateSetupInstructions(requiredServices),
                required_services: requiredServices,
                configuration_notes: generateConfigurationNotes(description, requiredServices),
                testing_procedures: generateTestingProcedures(description),
                troubleshooting: generateTroubleshooting(requiredServices)
            };
            
            requiredKeys = extractRequiredKeys(scenarioData.required_services);
            displayResults();
            showStep(4);
        }
        
        function generateRealisticBlueprint(description, services) {
            const desc = description.toLowerCase();
            const modules = [];
            let moduleId = 1;
            
            // Always start with webhook if it's a trigger
            if (desc.includes('when') || desc.includes('if') || !desc.includes('schedule')) {
                modules.push({
                    id: moduleId++,
                    app: "webhook",
                    module: "webhook",
                    version: 1,
                    parameters: {
                        hook: 1
                    },
                    mapper: {},
                    metadata: {
                        designer: {
                            x: 0,
                            y: 0
                        },
                        restore: {
                            parameters: {
                                hook: {
                                    data: {
                                        editable: "true"
                                    },
                                    label: "Webhook"
                                }
                            }
                        },
                        parameters: [
                            {
                                name: "hook",
                                type: "hook",
                                label: "Webhook",
                                required: true
                            }
                        ]
                    }
                });
            } else {
                // Schedule trigger
                modules.push({
                    id: moduleId++,
                    app: "builtin",
                    module: "BasicScheduler",
                    version: 1,
                    parameters: {},
                    mapper: {
                        interval: desc.includes('daily') ? [{"value": "1", "unit": "day"}] : 
                                 desc.includes('hourly') ? [{"value": "1", "unit": "hour"}] :
                                 [{"value": "15", "unit": "minute"}]
                    },
                    metadata: {
                        designer: {
                            x: 0,
                            y: 0
                        },
                        restore: {
                            parameters: {},
                            expect: [
                                {
                                    name: "interval",
                                    type: "interval",
                                    label: "Interval",
                                    required: true
                                }
                            ]
                        }
                    }
                });
            }
            
            // Add service-specific modules
            services.forEach((service, index) => {
                if (service.name === 'Gmail') {
                    if (desc.includes('send') || desc.includes('email')) {
                        modules.push({
                            id: moduleId++,
                            app: "gmail",
                            module: "SendAnEmail",
                            version: 1,
                            parameters: { account: 1 },
                            mapper: {
                                to: [{"value": "{{1.email}}"}],
                                subject: [{"value": "Automated Email"}],
                                html: [{"value": "{{1.content}}"}]
                            },
                            metadata: {
                                designer: { x: 300 * (index + 1), y: 0 }
                            }
                        });
                    }
                }
                
                if (service.name === 'Slack') {
                    modules.push({
                        id: moduleId++,
                        app: "slack",
                        module: "CreateAMessage",
                        version: 1,
                        parameters: { account: 1 },
                        mapper: {
                            channel: [{"value": "#general"}],
                            text: [{"value": "{{1.message}}"}],
                            username: [{"value": "Make Bot"}]
                        },
                        metadata: {
                            designer: { x: 300 * (index + 1), y: 0 }
                        }
                    });
                }
                
                if (service.name === 'Google Sheets') {
                    if (desc.includes('add') || desc.includes('create') || desc.includes('row')) {
                        modules.push({
                            id: moduleId++,
                            app: "google-sheets",
                            module: "AddARow",
                            version: 2,
                            parameters: { account: 1 },
                            mapper: {
                                spreadsheetId: [{"value": "YOUR_SPREADSHEET_ID"}],
                                includesHeaders: [{"value": "yes"}],
                                values: [{"value": "{{1.data}}"}]
                            },
                            metadata: {
                                designer: { x: 300 * (index + 1), y: 0 }
                            }
                        });
                    } else {
                        modules.push({
                            id: moduleId++,
                            app: "google-sheets",
                            module: "SearchRows",
                            version: 2,
                            parameters: { account: 1 },
                            mapper: {
                                spreadsheetId: [{"value": "YOUR_SPREADSHEET_ID"}],
                                includesHeaders: [{"value": "yes"}]
                            },
                            metadata: {
                                designer: { x: 300 * (index + 1), y: 0 }
                            }
                        });
                    }
                }
                
                if (service.name === 'OpenWeatherMap') {
                    modules.push({
                        id: moduleId++,
                        app: "openweathermap",
                        module: "GetCurrentWeather",
                        version: 1,
                        parameters: { account: 1 },
                        mapper: {
                            city: [{"value": "New York"}],
                            units: [{"value": "metric"}]
                        },
                        metadata: {
                            designer: { x: 300 * (index + 1), y: 0 }
                        }
                    });
                }
            });
            
            // Generate connections between modules
            const connections = [];
            for (let i = 0; i < modules.length - 1; i++) {
                connections.push({
                    id: i + 1,
                    src_module_id: modules[i].id,
                    tgt_module_id: modules[i + 1].id
                });
            }
            
            return {
                name: "AI Generated: " + description.substring(0, 50) + "...",
                flow: modules,
                metadata: {
                    instant: false,
                    version: 1,
                    scenario: {
                        roundtrips: 1,
                        maxErrors: 3,
                        autoCommit: false,
                        autoCommitTriggerLast: true,
                        sequential: false,
                        slots: null,
                        confidential: false,
                        dataloss: false,
                        dlq: false,
                        freshworksMigrated: false
                    },
                    designer: {
                        orphans: []
                    },
                    zone: "us1.make.com"
                },
                connections: connections,
                notes: [
                    {
                        id: 1,
                        text: "Generated by AI Scenario Builder",
                        color: "blue",
                        position: { x: 100, y: 50 }
                    },
                    {
                        id: 2,
                        text: "Remember to:\n• Configure API connections\n• Test each module\n• Update placeholder values",
                        color: "yellow",
                        position: { x: 100, y: 150 }
                    }
                ]
            };
        }
        
        function generateSetupInstructions(services) {
            const instructions = [
                "🚀 Setup Instructions:",
                "1. Import this blueprint into Make.com",
                "2. Create accounts for required services:"
            ];
            
            services.forEach(service => {
                instructions.push(`   • ${service.name}: ${service.signup_url}`);
            });
            
            instructions.push(
                "3. Configure connections in Make.com:",
                "   • Go to Connections tab",
                "   • Add new connection for each service",
                "   • Enter your API credentials",
                "4. Update module parameters:",
                "   • Replace placeholder values (YOUR_SPREADSHEET_ID, etc.)",
                "   • Configure channels, recipients, file paths",
                "5. Test the scenario:",
                "   • Run once manually",
                "   • Check all modules execute correctly",
                "   • Enable scheduling if needed",
                "6. Monitor and troubleshoot:",
                "   • Check execution history",
                "   • Review error logs",
                "   • Adjust filters and conditions"
            );
            
            return instructions;
        }
        
        function generateConfigurationNotes(description, services) {
            let notes = `📋 Configuration Notes for: "${description}"\n\n`;
            
            notes += "🔧 Key Configuration Points:\n";
            services.forEach(service => {
                switch(service.name) {
                    case 'Gmail':
                        notes += "• Gmail: Enable Gmail API, create OAuth2 credentials\n";
                        notes += "• Set appropriate scopes: gmail.send, gmail.readonly\n";
                        break;
                    case 'Slack':
                        notes += "• Slack: Create app, get Bot User OAuth Token\n";
                        notes += "• Add bot to channels, set permissions\n";
                        break;
                    case 'Google Sheets':
                        notes += "• Sheets: Share spreadsheet with service account email\n";
                        notes += "• Note the spreadsheet ID from URL\n";
                        break;
                    case 'OpenWeatherMap':
                        notes += "• Weather: Free tier allows 1000 calls/day\n";
                        notes += "• Use city names or coordinates\n";
                        break;
                }
            });
            
            notes += "\n⚠️  Important:\n";
            notes += "• Test with small data sets first\n";
            notes += "• Set up error handling\n";
            notes += "• Monitor usage limits\n";
            notes += "• Back up important data\n";
            
            return notes;
        }
        
        function generateTestingProcedures(description) {
            return [
                "🧪 Testing Procedures:",
                "1. Manual Test Run:",
                "   • Click 'Run once' button",
                "   • Verify trigger activation",
                "   • Check each module execution",
                "2. Data Validation:",
                "   • Confirm correct data mapping",
                "   • Verify output formats",
                "   • Test edge cases",
                "3. Error Handling:",
                "   • Test with invalid inputs",
                "   • Verify error notifications",
                "   • Check retry mechanisms",
                "4. Performance Testing:",
                "   • Test with realistic data volumes",
                "   • Monitor execution times",
                "   • Check rate limits",
                "5. Integration Testing:",
                "   • Test end-to-end workflow",
                "   • Verify external service responses",
                "   • Confirm final outputs"
            ];
        }
        
        function generateTroubleshooting(services) {
            const troubleshooting = {
                "Common Issues": [
                    "❌ Authentication failures → Check API keys/tokens",
                    "❌ Rate limiting → Reduce frequency or add delays",
                    "❌ Data mapping errors → Verify field names and types",
                    "❌ Network timeouts → Add retry logic"
                ],
                "Service-Specific": {}
            };
            
            services.forEach(service => {
                switch(service.name) {
                    case 'Gmail':
                        troubleshooting["Service-Specific"]["Gmail"] = [
                            "• 'Insufficient permissions' → Check OAuth scopes",
                            "• 'Daily limit exceeded' → Wait or upgrade quota"
                        ];
                        break;
                    case 'Slack':
                        troubleshooting["Service-Specific"]["Slack"] = [
                            "• 'Channel not found' → Check channel name/permissions",
                            "• 'Not in channel' → Add bot to channel"
                        ];
                        break;
                    case 'Google Sheets':
                        troubleshooting["Service-Specific"]["Sheets"] = [
                            "• 'Spreadsheet not found' → Check ID and sharing",
                            "• 'Range errors' → Verify sheet names and ranges"
                        ];
                        break;
                }
            });
            
            return troubleshooting;
        }
        
        function detectRequiredServices(description) {
            const services = [];
            const desc = description.toLowerCase();
            
            if (desc.includes('email') || desc.includes('gmail')) {
                services.push({
                    name: 'Gmail',
                    signup_url: 'https://gmail.com',
                    api_docs: 'https://developers.google.com/gmail/api',
                    required_credentials: ['client_id', 'client_secret', 'refresh_token']
                });
            }
            
            if (desc.includes('slack')) {
                services.push({
                    name: 'Slack',
                    signup_url: 'https://slack.com',
                    api_docs: 'https://api.slack.com',
                    required_credentials: ['bot_token']
                });
            }
            
            if (desc.includes('sheets') || desc.includes('google')) {
                services.push({
                    name: 'Google Sheets',
                    signup_url: 'https://sheets.google.com',
                    api_docs: 'https://developers.google.com/sheets/api',
                    required_credentials: ['service_account_json']
                });
            }
            
            if (desc.includes('twitter')) {
                services.push({
                    name: 'Twitter',
                    signup_url: 'https://twitter.com',
                    api_docs: 'https://developer.twitter.com',
                    required_credentials: ['api_key', 'api_secret', 'access_token', 'access_token_secret']
                });
            }
            
            if (desc.includes('weather')) {
                services.push({
                    name: 'OpenWeatherMap',
                    signup_url: 'https://openweathermap.org/api',
                    api_docs: 'https://openweathermap.org/api',
                    required_credentials: ['api_key']
                });
            }
            
            return services;
        }
        
        function extractRequiredKeys(services) {
            const keys = [];
            services.forEach(service => {
                service.required_credentials.forEach(cred => {
                    keys.push({
                        service: service.name,
                        key: cred,
                        value: '',
                        configured: false
                    });
                });
            });
            return keys;
        }
        
        function displayResults() {
            const resultsDiv = document.getElementById('results');
            const feedbackDiv = document.getElementById('feedback-section');
            
            resultsDiv.innerHTML = `
                <div class="success">
                    <h4>🎉 Scenario Generated Successfully!</h4>
                    <p><strong>Blueprint:</strong> ${scenarioData.blueprint.name}</p>
                    <p><strong>Modules:</strong> ${scenarioData.blueprint.modules.length} modules configured</p>
                    <p><strong>Services needed:</strong> ${scenarioData.required_services.map(s => s.name).join(', ')}</p>
                </div>
                
                <div class="feedback-item">
                    <h4>📋 Setup Instructions</h4>
                    ${scenarioData.setup_instructions.map(step => `<p style="margin: 2px 0; font-size: 14px;">${step}</p>`).join('')}
                </div>
                
                <div class="feedback-item">
                    <h4>⚙️ Configuration Notes</h4>
                    <pre style="white-space: pre-wrap; font-size: 12px; background: #f8f9fa; padding: 10px; border-radius: 4px;">${scenarioData.configuration_notes}</pre>
                </div>
                
                <div class="feedback-item">
                    <h4>🧪 Testing Procedures</h4>
                    ${scenarioData.testing_procedures.map(step => `<p style="margin: 2px 0; font-size: 14px;">${step}</p>`).join('')}
                </div>
                
                <div class="feedback-item">
                    <h4>🔧 Troubleshooting Guide</h4>
                    <div style="font-size: 14px;">
                        <strong>Common Issues:</strong>
                        ${scenarioData.troubleshooting["Common Issues"].map(issue => `<p style="margin: 2px 0;">${issue}</p>`).join('')}
                        ${Object.keys(scenarioData.troubleshooting["Service-Specific"]).length > 0 ? 
                            `<strong>Service-Specific:</strong>
                            ${Object.entries(scenarioData.troubleshooting["Service-Specific"]).map(([service, issues]) => 
                                `<p><strong>${service}:</strong></p>${issues.map(issue => `<p style="margin: 2px 0 2px 20px;">${issue}</p>`).join('')}`
                            ).join('')}` : ''
                        }
                    </div>
                </div>
            `;
            
            if (requiredKeys.length > 0) {
                feedbackDiv.innerHTML = `
                    <div class="warning">
                        <h4>🔑 API Keys & Credentials Required</h4>
                        <p>Please provide the following credentials to complete setup:</p>
                    </div>
                    <div id="api-setup-guides"></div>
                    <div id="keys-container"></div>
                `;
                
                displayApiSetupGuides();
                displayKeyInputs();
            } else {
                feedbackDiv.innerHTML = `
                    <div class="success">
                        <h4>✅ No Additional Credentials Required</h4>
                        <p>This scenario uses built-in Make.com features only.</p>
                    </div>
                `;
            }
        }
        
        function displayKeyInputs() {
            const container = document.getElementById('keys-container');
            
            requiredKeys.forEach((keyInfo, index) => {
                const keyDiv = document.createElement('div');
                keyDiv.className = 'feedback-item';
                keyDiv.innerHTML = `
                    <h4>${keyInfo.service} - ${keyInfo.key}</h4>
                    <p>Required for ${keyInfo.service} integration</p>
                    <div class="key-input">
                        <input type="password" 
                               id="key-${index}" 
                               placeholder="Enter your ${keyInfo.key}"
                               onchange="updateKey(${index}, this.value)">
                        <small style="color: #666;">Get this from: ${getKeyInstructions(keyInfo.service, keyInfo.key)}</small>
                    </div>
                `;
                container.appendChild(keyDiv);
            });
        }
        
        function getKeyInstructions(service, key) {
            const instructions = {
                'Gmail': 'Google Cloud Console → APIs & Services → Credentials',
                'Slack': 'Slack API → Your Apps → OAuth & Permissions',
                'Google Sheets': 'Google Cloud Console → Service Accounts',
                'Twitter': 'Twitter Developer Portal → Apps → Keys and tokens',
                'OpenWeatherMap': 'OpenWeatherMap → API keys'
            };
            return instructions[service] || 'Service documentation';
        }
        
        function updateKey(index, value) {
            requiredKeys[index].value = value;
            requiredKeys[index].configured = value.length > 0;
            saveKeysToLocalStorage();
            
            // Update visual feedback
            const input = document.getElementById(`key-${index}`);
            input.style.borderColor = value.length > 0 ? '#28a745' : '#e1e5e9';
        }
        
        function downloadBlueprint() {
            const configuredKeys = requiredKeys.filter(k => k.configured);
            
            if (configuredKeys.length < requiredKeys.length) {
                const missing = requiredKeys.filter(k => !k.configured);
                alert(`Please configure these keys first: ${missing.map(k => k.service + ' ' + k.key).join(', ')}`);
                return;
            }
            
            // Create enhanced blueprint with user's keys
            const enhancedBlueprint = {
                ...scenarioData,
                user_credentials: requiredKeys,
                generated_at: new Date().toISOString(),
                mobile_configured: true
            };
            
            addLog('Blueprint ready – downloading', 'success');
            const blob = new Blob([JSON.stringify(enhancedBlueprint, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ai-generated-scenario.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function startOver() {
            currentStep = 1;
            scenarioData = null;
            requiredKeys = [];
            document.getElementById('description').value = '';
            document.getElementById('results').innerHTML = '';
            document.getElementById('feedback-section').innerHTML = '';
            showStep(1);
        }
        
        function showError(message) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="error">
                    <h4>❌ Error</h4>
                    <p>${message}</p>
                </div>
            `;
        }
        
        // Speech-to-text
        function startSpeechRecognition(event) {
            event.preventDefault();
            const btn = event.currentTarget;
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                alert('Speech recognition not supported in this browser');
                return;
            }
            const recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.continuous = false;

            btn.classList.add('active');
            recognition.start();

            recognition.onresult = function(e) {
                const transcript = e.results[0][0].transcript;
                const textarea = document.getElementById('description');
                textarea.value = textarea.value ? textarea.value + ' ' + transcript : transcript;
                btn.classList.remove('active');
            };

            recognition.onerror = function(err) {
                addLog('Speech recognition error: ' + err.message, 'error');
                btn.classList.remove('active');
            };
        }

        // Logging helpers
        function addLog(message, type = 'info') {
            logs.push({ message, type, ts: Date.now() });
            const logContainer = document.getElementById('logContainer');
            logContainer.style.display = 'block';
            const div = document.createElement('div');
            div.className = 'log-item ' + type;
            div.textContent = new Date().toLocaleTimeString() + ' – ' + message;
            logContainer.appendChild(div);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Persist keys
        function saveKeysToLocalStorage() {
            localStorage.setItem('storedKeys', JSON.stringify(requiredKeys));
            displayConnectedApps();
        }

        function loadStoredKeys() {
            try {
                const stored = JSON.parse(localStorage.getItem('storedKeys') || '[]');
                stored.forEach(k => k.configured = true);
                return stored;
            } catch (_) {
                return [];
            }
        }

        function displayConnectedApps() {
            const container = document.getElementById('connectedApps');
            if (!container) return;

            const stored = loadStoredKeys().filter(k => k.configured);
            if (stored.length === 0) {
                container.innerHTML = '<em>No stored credentials found.</em>';
                return;
            }

            const byService = {};
            stored.forEach(k => {
                if (!byService[k.service]) byService[k.service] = [];
                byService[k.service].push(k.key);
            });

            let html = '<strong>Connected Apps:</strong><ul>';
            Object.keys(byService).forEach(service => {
                html += `<li>${service}: ${byService[service].join(', ')}</li>`;
            });
            html += '</ul>';
            container.innerHTML = html;
        }
        
        // Initialize
        updateProgress();
        displayConnectedApps();
        
        // Claude Chat System
        let chatHistory = [];
        
        function toggleChat() {
            const chatContainer = document.getElementById('chatContainer');
            if (chatContainer.style.display === 'none' || !chatContainer.style.display) {
                chatContainer.style.display = 'block';
                if (chatHistory.length === 0) {
                    addChatMessage('claude', "Hi! I'm Claude, your AI assistant. I can help you with Make.com scenarios, API setup, troubleshooting, or answer any questions about automation. What would you like to know?");
                }
            } else {
                chatContainer.style.display = 'none';
            }
        }
        
        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }
        
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;
            
            input.value = '';
            addChatMessage('user', message);
            
            // Add thinking indicator
            const thinkingId = 'thinking-' + Date.now();
            addChatMessage('claude', '🤔 Thinking...', thinkingId);
            
            try {
                const response = await getClaude4Response(message);
                removeChatMessage(thinkingId);
                addChatMessage('claude', response);
            } catch (error) {
                removeChatMessage(thinkingId);
                addChatMessage('claude', "I'm sorry, I'm having trouble connecting right now. Here are some general tips: For Make.com issues, check your connections and test modules individually. For API setup, make sure you have the correct permissions and valid credentials.");
                addLog('Claude API error: ' + error.message, 'error');
            }
        }
        
        function addChatMessage(sender, content, messageId = null) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            if (messageId) messageDiv.id = messageId;
            
            messageDiv.innerHTML = `
                <div class="chat-avatar ${sender}">${sender === 'user' ? '👤' : '🤖'}</div>
                <div class="chat-content">${content}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            chatHistory.push({ sender, content, timestamp: Date.now() });
        }
        
        function removeChatMessage(messageId) {
            const message = document.getElementById(messageId);
            if (message) message.remove();
        }
        
        async function getClaude4Response(message) {
            // More contextual and conversational responses
            const lowerMessage = message.toLowerCase();
            
            // Handle greetings and casual messages
            if (lowerMessage.includes('hey') || lowerMessage.includes('hello') || lowerMessage.includes('hi')) {
                return `Hey there! 👋 I'm here to help you build awesome Make.com automations. Are you:\n\n• Setting up a new scenario?\n• Having trouble with API connections?\n• Looking for automation ideas?\n• Troubleshooting an existing setup?\n\nJust let me know what you're working on!`;
            }
            
            if (lowerMessage.includes('how to do this') || lowerMessage.includes('how do i')) {
                return `I'd love to help! But I need a bit more context. Are you asking about:\n\n🔧 Setting up API keys for a specific service?\n📋 Creating a particular type of automation?\n🐛 Fixing an error you're encountering?\n💻 How to use this AI builder tool?\n\nTell me more about what you're trying to accomplish and I can give you step-by-step guidance!`;
            }
            
            if (lowerMessage.includes('gmail') || lowerMessage.includes('email')) {
                return `Gmail setup is pretty straightforward! Here's what you need:\n\n📧 **Quick Gmail Setup:**\n1. Go to [Google Cloud Console](https://console.cloud.google.com/)\n2. Enable Gmail API\n3. Create OAuth2 credentials\n4. Add your domain to authorized domains\n5. Set scopes: gmail.send, gmail.readonly\n\n**Pro tip:** Make sure to add the Make.com redirect URI: \`https://www.make.com/oauth/cb/google-restricted\`\n\nStuck on any of these steps? Just ask!`;
            }
            
            if (lowerMessage.includes('slack')) {
                return `Slack integration is super useful! Here's the setup:\n\n💬 **Slack App Setup:**\n1. Create a Slack app at [api.slack.com/apps](https://api.slack.com/apps)\n2. Get your Bot User OAuth Token (starts with 'xoxb-')\n3. Add bot to your workspace\n4. Set permissions: \`chat:write\`, \`channels:read\`\n5. Invite bot to channels: \`/invite @yourbotname\`\n\n**Common issue:** Bot tokens expire! Make sure to regenerate if needed.\n\nNeed help with any specific step?`;
            }
            
            if (lowerMessage.includes('sheets') || lowerMessage.includes('google sheets')) {
                return `Google Sheets is perfect for data automation! Here's how to connect:\n\n📊 **Google Sheets Setup:**\n1. [Google Cloud Console](https://console.cloud.google.com/) → Service Accounts\n2. Create service account + download JSON key\n3. Share your spreadsheet with the service account email\n4. Get Spreadsheet ID from URL: \`docs.google.com/spreadsheets/d/SPREADSHEET_ID/edit\`\n\n**Pro tip:** The service account email looks like: \`your-service@project.iam.gserviceaccount.com\`\n\nWant me to walk through any of these steps in detail?`;
            }
            
            if (lowerMessage.includes('error') || lowerMessage.includes('not working') || lowerMessage.includes('failed')) {
                return `Uh oh! Let's debug this together 🔍\n\n**Quick troubleshooting checklist:**\n✅ API credentials valid and not expired?\n✅ Service permissions set correctly?\n✅ Test each module individually?\n✅ Check Make.com execution history?\n✅ Hit any rate limits?\n\n**What's the exact error message?** Copy-paste it here and I can give you specific guidance!\n\nAlso, which service is giving you trouble?`;
            }
            
            if (lowerMessage.includes('webhook')) {
                return `Webhooks are awesome for real-time automation! 🚀\n\n**Webhook Setup:**\n1. In Make.com: Add Webhook module\n2. Copy the webhook URL (starts with hook.make.com)\n3. Paste it in your trigger service\n4. Test with sample data\n5. Check data structure in Make.com\n\n**Pro tip:** Use webhook tools like [webhook.site](https://webhook.site) to test your payload structure first!\n\nWhich service are you trying to connect via webhook?`;
            }
            
            if (lowerMessage.includes('blueprint') || lowerMessage.includes('json')) {
                return `The Make.com blueprint format needs to be precise! 📋\n\n**Key blueprint elements:**\n• \`modules\`: Array of workflow steps\n• \`connections\`: Links between modules\n• \`metadata\`: Scenario settings\n• \`version\`: Blueprint format version\n\n**Common issues:**\n• Missing module IDs or wrong connections\n• Incorrect app/module names\n• Missing required parameters\n\nAre you having trouble with a specific part of the blueprint structure?`;
            }
            
            // Default contextual response
            return `I'm here to help with your Make.com automation! 🤖\n\n**I can help with:**\n🔧 API setup & configuration\n🔗 Connecting services\n🐛 Troubleshooting errors\n📋 Scenario optimization\n💡 Automation ideas\n📄 Blueprint formatting\n\n**What's your specific challenge?** The more details you share, the better I can help!\n\nFor example: "I'm trying to connect Gmail to Slack but getting authentication errors" or "How do I set up a daily weather email?"`;
        }
        
        function displayApiSetupGuides() {
            const container = document.getElementById('api-setup-guides');
            if (!container) return;
            
            let guidesHtml = '<div class="api-setup-guide"><h4>📚 Step-by-Step API Setup Guides</h4>';
            
            scenarioData.required_services.forEach(service => {
                guidesHtml += generateApiGuide(service);
            });
            
            guidesHtml += '</div>';
            container.innerHTML = guidesHtml;
        }
        
        function generateApiGuide(service) {
            switch(service.name) {
                case 'Gmail':
                    return `
                        <div class="api-step">
                            <h5>📧 Gmail API Setup</h5>
                            <p><strong>Step 1:</strong> Go to <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a></p>
                            <p><strong>Step 2:</strong> Create/select a project → APIs & Services → Library</p>
                            <p><strong>Step 3:</strong> Search "Gmail API" and enable it</p>
                            <p><strong>Step 4:</strong> Go to Credentials → Create Credentials → OAuth 2.0 Client IDs</p>
                            <p><strong>Step 5:</strong> Download JSON file or copy Client ID + Secret</p>
                            <p><strong>Step 6:</strong> Add authorized redirect URIs: <code>https://www.make.com/oauth/cb/google-restricted</code></p>
                            <p><a href="https://developers.google.com/gmail/api/quickstart" target="_blank">📖 Full Gmail API Documentation</a></p>
                        </div>
                    `;
                    
                case 'Slack':
                    return `
                        <div class="api-step">
                            <h5>💬 Slack App Setup</h5>
                            <p><strong>Step 1:</strong> Go to <a href="https://api.slack.com/apps" target="_blank">Slack API Apps</a></p>
                            <p><strong>Step 2:</strong> Click "Create New App" → From scratch</p>
                            <p><strong>Step 3:</strong> OAuth & Permissions → Bot Token Scopes</p>
                            <p><strong>Step 4:</strong> Add scopes: <code>chat:write</code>, <code>channels:read</code></p>
                            <p><strong>Step 5:</strong> Install to Workspace → Copy Bot User OAuth Token</p>
                            <p><strong>Step 6:</strong> Invite bot to channels: <code>/invite @yourbotname</code></p>
                            <p><a href="https://api.slack.com/tutorials/tracks/getting-a-token" target="_blank">📖 Slack Token Guide</a></p>
                        </div>
                    `;
                    
                case 'Google Sheets':
                    return `
                        <div class="api-step">
                            <h5>📊 Google Sheets API Setup</h5>
                            <p><strong>Step 1:</strong> <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a> → APIs & Services</p>
                            <p><strong>Step 2:</strong> Enable "Google Sheets API"</p>
                            <p><strong>Step 3:</strong> Credentials → Create Service Account</p>
                            <p><strong>Step 4:</strong> Download JSON key file</p>
                            <p><strong>Step 5:</strong> Share your spreadsheet with service account email</p>
                            <p><strong>Step 6:</strong> Get Spreadsheet ID from URL: <code>docs.google.com/spreadsheets/d/SPREADSHEET_ID/edit</code></p>
                            <p><a href="https://developers.google.com/sheets/api/quickstart" target="_blank">📖 Sheets API Quickstart</a></p>
                        </div>
                    `;
                    
                case 'OpenWeatherMap':
                    return `
                        <div class="api-step">
                            <h5>🌤️ OpenWeatherMap API Setup</h5>
                            <p><strong>Step 1:</strong> Sign up at <a href="https://openweathermap.org/api" target="_blank">OpenWeatherMap</a></p>
                            <p><strong>Step 2:</strong> Verify your email address</p>
                            <p><strong>Step 3:</strong> Go to API keys section in your account</p>
                            <p><strong>Step 4:</strong> Copy your default API key</p>
                            <p><strong>Step 5:</strong> Test with: <code>api.openweathermap.org/data/2.5/weather?q=London&appid=YOUR_API_KEY</code></p>
                            <p><strong>Note:</strong> Free tier: 1,000 calls/day, 60 calls/minute</p>
                            <p><a href="https://openweathermap.org/api/one-call-api" target="_blank">📖 Weather API Docs</a></p>
                        </div>
                    `;
                    
                case 'Twitter':
                    return `
                        <div class="api-step">
                            <h5>🐦 Twitter API Setup</h5>
                            <p><strong>Step 1:</strong> Apply at <a href="https://developer.twitter.com/" target="_blank">Twitter Developer Portal</a></p>
                            <p><strong>Step 2:</strong> Create a new app in your developer account</p>
                            <p><strong>Step 3:</strong> Generate API Key & Secret</p>
                            <p><strong>Step 4:</strong> Generate Access Token & Access Token Secret</p>
                            <p><strong>Step 5:</strong> Set app permissions (Read, Write, Direct Messages)</p>
                            <p><strong>Note:</strong> Twitter API access requires approval</p>
                            <p><a href="https://developer.twitter.com/en/docs/twitter-api" target="_blank">📖 Twitter API Documentation</a></p>
                        </div>
                    `;
                    
                default:
                    return `
                        <div class="api-step">
                            <h5>🔧 ${service.name} Setup</h5>
                            <p><strong>Sign up:</strong> <a href="${service.signup_url}" target="_blank">${service.signup_url}</a></p>
                            <p><strong>Documentation:</strong> <a href="${service.api_docs}" target="_blank">${service.api_docs}</a></p>
                        </div>
                    `;
            }
        }
    </script>
</body>
</html> 