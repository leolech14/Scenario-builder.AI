<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Scenario Builder Mobile</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .content {
            padding: 20px;
        }
        
        .step {
            display: none;
            animation: slideIn 0.3s ease-out;
        }
        
        .step.active {
            display: block;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 16px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
            -webkit-appearance: none;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        textarea {
            height: 120px;
            resize: vertical;
        }
        
        .btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #6c757d;
            margin-right: 10px;
            width: calc(50% - 5px);
        }
        
        .btn-primary {
            width: calc(50% - 5px);
        }
        
        .progress {
            height: 4px;
            background: #e1e5e9;
            border-radius: 2px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .feedback-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #667eea;
        }
        
        .feedback-item h4 {
            margin-bottom: 8px;
            color: #495057;
        }
        
        .feedback-item p {
            margin-bottom: 8px;
            color: #6c757d;
            font-size: 14px;
        }
        
        .key-input {
            margin-top: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 40px 20px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e1e5e9;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .examples {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .examples h3 {
            margin-bottom: 10px;
            color: #495057;
            font-size: 16px;
        }
        
        .example {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin: 8px 0;
            cursor: pointer;
            border: 1px solid #dee2e6;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .example:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .step-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e1e5e9;
            margin: 0 4px;
            transition: all 0.3s;
        }
        
        .step-dot.active {
            background: #667eea;
            transform: scale(1.2);
        }
        
        .step-dot.completed {
            background: #28a745;
        }
        
        @media (max-width: 480px) {
            .container {
                margin: 5px;
                border-radius: 12px;
            }
            
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .content {
                padding: 15px;
            }
            
            .btn-secondary, .btn-primary {
                width: 100%;
                margin: 5px 0;
            }
        }
        
        /* microphone button */
        .mic-btn {
            background: #e1e5e9;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            margin-left: 8px;
            cursor: pointer;
            transition: background 0.2s;
            vertical-align: middle;
        }
        
        .mic-btn.active {
            background: #667eea;
            color: #fff;
        }
        
        /* connected apps */
        .connected-apps {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
            font-size: 14px;
        }
        
        /* logs */
        .logs {
            max-height: 120px;
            overflow-y: auto;
            font-size: 12px;
            margin-top: 10px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 8px;
            background: #fefefe;
            display: none; /* hidden until first log arrives */
        }
        
        .log-item {
            margin-bottom: 2px;
        }
        
        .log-item.success { color: #28a745; }
        .log-item.error { color: #dc3545; }
        .log-item.info { color: #6c757d; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ AI Scenario Builder</h1>
            <p>Create Make.com automations with AI assistance</p>
        </div>
        
        <div class="content">
            <div class="step-indicator">
                <div class="step-dot active" data-step="1"></div>
                <div class="step-dot" data-step="2"></div>
                <div class="step-dot" data-step="3"></div>
                <div class="step-dot" data-step="4"></div>
            </div>
            
            <div class="progress">
                <div class="progress-bar" style="width: 25%"></div>
            </div>
            
            <div id="logContainer" class="logs"></div>
            
            <!-- Step 1: Configuration -->
            <div class="step active" id="step1">
                <h2>‚öôÔ∏è Configuration</h2>
                <div class="form-group">
                    <label for="webhookUrl">Make.com Webhook URL:</label>
                    <input type="url" id="webhookUrl" placeholder="https://hook.us1.make.com/..." value="https://hook.us2.make.com/l4hnd2qdxuivmeix2jrwmva6c495zlwe" required>
                    <small style="color: #666; font-size: 12px;">Get this from your Make.com scenario Module 1</small>
                </div>
                <div id="connectedApps" class="connected-apps"></div>
                <button class="btn" onclick="nextStep()">Continue</button>
            </div>
            
            <!-- Step 2: Automation Request -->
            <div class="step" id="step2">
                <h2>üìù Describe Your Automation</h2>
                
                <div class="form-group">
                    <label for="description">What do you want to automate?
                        <button type="button" class="mic-btn" onclick="startSpeechRecognition(event)">üé§</button>
                    </label>
                    <textarea id="description" placeholder="Describe your automation in detail..." required></textarea>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="prevStep()">Back</button>
                    <button class="btn btn-primary" onclick="generateScenario()">Generate</button>
                </div>
            </div>
            
            <!-- Step 3: Processing -->
            <div class="step" id="step3">
                <div class="loading">
                    <div class="spinner"></div>
                    <h3>ü§ñ AI is creating your scenario...</h3>
                    <p>This may take 10-30 seconds</p>
                </div>
            </div>
            
            <!-- Step 4: Results & Feedback -->
            <div class="step" id="step4">
                <h2>‚úÖ Scenario Generated!</h2>
                <div id="results"></div>
                <div id="feedback-section"></div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="startOver()">Start Over</button>
                    <button class="btn btn-primary" onclick="downloadBlueprint()">Download</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let scenarioData = null;
        let requiredKeys = [];
        let logs = [];
        
        function updateProgress() {
            const progress = (currentStep / 4) * 100;
            document.querySelector('.progress-bar').style.width = progress + '%';
            
            // Update step indicators
            document.querySelectorAll('.step-dot').forEach((dot, index) => {
                const stepNum = index + 1;
                dot.classList.remove('active', 'completed');
                
                if (stepNum < currentStep) {
                    dot.classList.add('completed');
                } else if (stepNum === currentStep) {
                    dot.classList.add('active');
                }
            });
        }
        
        function showStep(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');
            currentStep = step;
            updateProgress();
        }
        
        function nextStep() {
            if (currentStep === 1) {
                const webhookUrl = document.getElementById('webhookUrl').value;
                if (!webhookUrl || !webhookUrl.includes('hook.') || !webhookUrl.includes('make.com')) {
                    alert('Please enter a valid Make.com webhook URL');
                    return;
                }
            }
            
            if (currentStep < 4) {
                showStep(currentStep + 1);
            }
        }
        
        function prevStep() {
            if (currentStep > 1) {
                showStep(currentStep - 1);
            }
        }
        
        function setExample(text) {
            document.getElementById('description').value = text;
        }
        
        async function generateScenario() {
            const webhookUrl = document.getElementById('webhookUrl').value;
            const description = document.getElementById('description').value;
            
            if (!description.trim()) {
                alert('Please describe what you want to automate');
                return;
            }
            
            showStep(3); // Show loading
            
            try {
                addLog('Posting description to webhook', 'info');
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        description: description,
                        callback_url: window.location.origin + '/callback'
                    })
                });
                
                if (response.ok) {
                    addLog('Webhook accepted request ‚Äì awaiting AI generation', 'success');
                    // Simulate AI processing time
                    setTimeout(() => {
                        simulateScenarioResponse(description);
                    }, 3000);
                } else {
                    addLog('Webhook returned HTTP ' + response.status, 'error');
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
            } catch (error) {
                addLog('Scenario generation failed: ' + error.message, 'error');
                showError('Failed to generate scenario: ' + error.message);
                showStep(2);
            }
        }
        
        function simulateScenarioResponse(description) {
            const requiredServices = detectRequiredServices(description);
            const blueprint = generateRealisticBlueprint(description, requiredServices);
            
            scenarioData = {
                blueprint: blueprint,
                setup_instructions: generateSetupInstructions(requiredServices),
                required_services: requiredServices,
                configuration_notes: generateConfigurationNotes(description, requiredServices),
                testing_procedures: generateTestingProcedures(description),
                troubleshooting: generateTroubleshooting(requiredServices)
            };
            
            requiredKeys = extractRequiredKeys(scenarioData.required_services);
            displayResults();
            showStep(4);
        }
        
        function generateRealisticBlueprint(description, services) {
            const desc = description.toLowerCase();
            const modules = [];
            let moduleId = 1;
            
            // Always start with webhook if it's a trigger
            if (desc.includes('when') || desc.includes('if') || !desc.includes('schedule')) {
                modules.push({
                    id: moduleId++,
                    app: "webhook",
                    module: "webhook",
                    version: 1,
                    parameters: {
                        hook: 1,
                        url: "/webhook/hook"
                    },
                    mapper: {},
                    metadata: {
                        designer: { x: 0, y: 0 },
                        restore: {}
                    }
                });
            } else {
                // Schedule trigger
                modules.push({
                    id: moduleId++,
                    app: "builtin",
                    module: "BasicScheduler",
                    version: 1,
                    parameters: {},
                    mapper: {
                        interval: desc.includes('daily') ? [{"value": "1", "unit": "day"}] : 
                                 desc.includes('hourly') ? [{"value": "1", "unit": "hour"}] :
                                 [{"value": "15", "unit": "minute"}]
                    },
                    metadata: {
                        designer: { x: 0, y: 0 }
                    }
                });
            }
            
            // Add service-specific modules
            services.forEach((service, index) => {
                if (service.name === 'Gmail') {
                    if (desc.includes('send') || desc.includes('email')) {
                        modules.push({
                            id: moduleId++,
                            app: "gmail",
                            module: "SendAnEmail",
                            version: 1,
                            parameters: { account: 1 },
                            mapper: {
                                to: [{"value": "{{1.email}}"}],
                                subject: [{"value": "Automated Email"}],
                                html: [{"value": "{{1.content}}"}]
                            },
                            metadata: {
                                designer: { x: 300 * (index + 1), y: 0 }
                            }
                        });
                    }
                }
                
                if (service.name === 'Slack') {
                    modules.push({
                        id: moduleId++,
                        app: "slack",
                        module: "CreateAMessage",
                        version: 1,
                        parameters: { account: 1 },
                        mapper: {
                            channel: [{"value": "#general"}],
                            text: [{"value": "{{1.message}}"}],
                            username: [{"value": "Make Bot"}]
                        },
                        metadata: {
                            designer: { x: 300 * (index + 1), y: 0 }
                        }
                    });
                }
                
                if (service.name === 'Google Sheets') {
                    if (desc.includes('add') || desc.includes('create') || desc.includes('row')) {
                        modules.push({
                            id: moduleId++,
                            app: "google-sheets",
                            module: "AddARow",
                            version: 2,
                            parameters: { account: 1 },
                            mapper: {
                                spreadsheetId: [{"value": "YOUR_SPREADSHEET_ID"}],
                                includesHeaders: [{"value": "yes"}],
                                values: [{"value": "{{1.data}}"}]
                            },
                            metadata: {
                                designer: { x: 300 * (index + 1), y: 0 }
                            }
                        });
                    } else {
                        modules.push({
                            id: moduleId++,
                            app: "google-sheets",
                            module: "SearchRows",
                            version: 2,
                            parameters: { account: 1 },
                            mapper: {
                                spreadsheetId: [{"value": "YOUR_SPREADSHEET_ID"}],
                                includesHeaders: [{"value": "yes"}]
                            },
                            metadata: {
                                designer: { x: 300 * (index + 1), y: 0 }
                            }
                        });
                    }
                }
                
                if (service.name === 'OpenWeatherMap') {
                    modules.push({
                        id: moduleId++,
                        app: "openweathermap",
                        module: "GetCurrentWeather",
                        version: 1,
                        parameters: { account: 1 },
                        mapper: {
                            city: [{"value": "New York"}],
                            units: [{"value": "metric"}]
                        },
                        metadata: {
                            designer: { x: 300 * (index + 1), y: 0 }
                        }
                    });
                }
            });
            
            // Generate connections between modules
            const connections = [];
            for (let i = 0; i < modules.length - 1; i++) {
                connections.push({
                    id: i + 1,
                    src_module_id: modules[i].id,
                    tgt_module_id: modules[i + 1].id
                });
            }
            
            return {
                name: "AI Generated: " + description.substring(0, 50) + "...",
                description: "Auto-generated Make.com scenario based on: " + description,
                version: 1,
                modules: modules,
                metadata: {
                    version: 1,
                    scenario: {
                        roundtrips: 1,
                        maxErrors: 3,
                        autoCommit: false,
                        sequential: false,
                        confidential: false,
                        dataloss: false,
                        dlq: false
                    },
                    designer: {
                        orphans: []
                    },
                    zone: "us1.make.com"
                },
                connections: connections
            };
        }
        
        function generateSetupInstructions(services) {
            const instructions = [
                "üöÄ Setup Instructions:",
                "1. Import this blueprint into Make.com",
                "2. Create accounts for required services:"
            ];
            
            services.forEach(service => {
                instructions.push(`   ‚Ä¢ ${service.name}: ${service.signup_url}`);
            });
            
            instructions.push(
                "3. Configure connections in Make.com:",
                "   ‚Ä¢ Go to Connections tab",
                "   ‚Ä¢ Add new connection for each service",
                "   ‚Ä¢ Enter your API credentials",
                "4. Update module parameters:",
                "   ‚Ä¢ Replace placeholder values (YOUR_SPREADSHEET_ID, etc.)",
                "   ‚Ä¢ Configure channels, recipients, file paths",
                "5. Test the scenario:",
                "   ‚Ä¢ Run once manually",
                "   ‚Ä¢ Check all modules execute correctly",
                "   ‚Ä¢ Enable scheduling if needed",
                "6. Monitor and troubleshoot:",
                "   ‚Ä¢ Check execution history",
                "   ‚Ä¢ Review error logs",
                "   ‚Ä¢ Adjust filters and conditions"
            );
            
            return instructions;
        }
        
        function generateConfigurationNotes(description, services) {
            let notes = `üìã Configuration Notes for: "${description}"\n\n`;
            
            notes += "üîß Key Configuration Points:\n";
            services.forEach(service => {
                switch(service.name) {
                    case 'Gmail':
                        notes += "‚Ä¢ Gmail: Enable Gmail API, create OAuth2 credentials\n";
                        notes += "‚Ä¢ Set appropriate scopes: gmail.send, gmail.readonly\n";
                        break;
                    case 'Slack':
                        notes += "‚Ä¢ Slack: Create app, get Bot User OAuth Token\n";
                        notes += "‚Ä¢ Add bot to channels, set permissions\n";
                        break;
                    case 'Google Sheets':
                        notes += "‚Ä¢ Sheets: Share spreadsheet with service account email\n";
                        notes += "‚Ä¢ Note the spreadsheet ID from URL\n";
                        break;
                    case 'OpenWeatherMap':
                        notes += "‚Ä¢ Weather: Free tier allows 1000 calls/day\n";
                        notes += "‚Ä¢ Use city names or coordinates\n";
                        break;
                }
            });
            
            notes += "\n‚ö†Ô∏è  Important:\n";
            notes += "‚Ä¢ Test with small data sets first\n";
            notes += "‚Ä¢ Set up error handling\n";
            notes += "‚Ä¢ Monitor usage limits\n";
            notes += "‚Ä¢ Back up important data\n";
            
            return notes;
        }
        
        function generateTestingProcedures(description) {
            return [
                "üß™ Testing Procedures:",
                "1. Manual Test Run:",
                "   ‚Ä¢ Click 'Run once' button",
                "   ‚Ä¢ Verify trigger activation",
                "   ‚Ä¢ Check each module execution",
                "2. Data Validation:",
                "   ‚Ä¢ Confirm correct data mapping",
                "   ‚Ä¢ Verify output formats",
                "   ‚Ä¢ Test edge cases",
                "3. Error Handling:",
                "   ‚Ä¢ Test with invalid inputs",
                "   ‚Ä¢ Verify error notifications",
                "   ‚Ä¢ Check retry mechanisms",
                "4. Performance Testing:",
                "   ‚Ä¢ Test with realistic data volumes",
                "   ‚Ä¢ Monitor execution times",
                "   ‚Ä¢ Check rate limits",
                "5. Integration Testing:",
                "   ‚Ä¢ Test end-to-end workflow",
                "   ‚Ä¢ Verify external service responses",
                "   ‚Ä¢ Confirm final outputs"
            ];
        }
        
        function generateTroubleshooting(services) {
            const troubleshooting = {
                "Common Issues": [
                    "‚ùå Authentication failures ‚Üí Check API keys/tokens",
                    "‚ùå Rate limiting ‚Üí Reduce frequency or add delays",
                    "‚ùå Data mapping errors ‚Üí Verify field names and types",
                    "‚ùå Network timeouts ‚Üí Add retry logic"
                ],
                "Service-Specific": {}
            };
            
            services.forEach(service => {
                switch(service.name) {
                    case 'Gmail':
                        troubleshooting["Service-Specific"]["Gmail"] = [
                            "‚Ä¢ 'Insufficient permissions' ‚Üí Check OAuth scopes",
                            "‚Ä¢ 'Daily limit exceeded' ‚Üí Wait or upgrade quota"
                        ];
                        break;
                    case 'Slack':
                        troubleshooting["Service-Specific"]["Slack"] = [
                            "‚Ä¢ 'Channel not found' ‚Üí Check channel name/permissions",
                            "‚Ä¢ 'Not in channel' ‚Üí Add bot to channel"
                        ];
                        break;
                    case 'Google Sheets':
                        troubleshooting["Service-Specific"]["Sheets"] = [
                            "‚Ä¢ 'Spreadsheet not found' ‚Üí Check ID and sharing",
                            "‚Ä¢ 'Range errors' ‚Üí Verify sheet names and ranges"
                        ];
                        break;
                }
            });
            
            return troubleshooting;
        }
        
        function detectRequiredServices(description) {
            const services = [];
            const desc = description.toLowerCase();
            
            if (desc.includes('email') || desc.includes('gmail')) {
                services.push({
                    name: 'Gmail',
                    signup_url: 'https://gmail.com',
                    api_docs: 'https://developers.google.com/gmail/api',
                    required_credentials: ['client_id', 'client_secret', 'refresh_token']
                });
            }
            
            if (desc.includes('slack')) {
                services.push({
                    name: 'Slack',
                    signup_url: 'https://slack.com',
                    api_docs: 'https://api.slack.com',
                    required_credentials: ['bot_token']
                });
            }
            
            if (desc.includes('sheets') || desc.includes('google')) {
                services.push({
                    name: 'Google Sheets',
                    signup_url: 'https://sheets.google.com',
                    api_docs: 'https://developers.google.com/sheets/api',
                    required_credentials: ['service_account_json']
                });
            }
            
            if (desc.includes('twitter')) {
                services.push({
                    name: 'Twitter',
                    signup_url: 'https://twitter.com',
                    api_docs: 'https://developer.twitter.com',
                    required_credentials: ['api_key', 'api_secret', 'access_token', 'access_token_secret']
                });
            }
            
            if (desc.includes('weather')) {
                services.push({
                    name: 'OpenWeatherMap',
                    signup_url: 'https://openweathermap.org/api',
                    api_docs: 'https://openweathermap.org/api',
                    required_credentials: ['api_key']
                });
            }
            
            return services;
        }
        
        function extractRequiredKeys(services) {
            const keys = [];
            services.forEach(service => {
                service.required_credentials.forEach(cred => {
                    keys.push({
                        service: service.name,
                        key: cred,
                        value: '',
                        configured: false
                    });
                });
            });
            return keys;
        }
        
        function displayResults() {
            const resultsDiv = document.getElementById('results');
            const feedbackDiv = document.getElementById('feedback-section');
            
            resultsDiv.innerHTML = `
                <div class="success">
                    <h4>üéâ Scenario Generated Successfully!</h4>
                    <p><strong>Blueprint:</strong> ${scenarioData.blueprint.name}</p>
                    <p><strong>Modules:</strong> ${scenarioData.blueprint.modules.length} modules configured</p>
                    <p><strong>Services needed:</strong> ${scenarioData.required_services.map(s => s.name).join(', ')}</p>
                </div>
                
                <div class="feedback-item">
                    <h4>üìã Setup Instructions</h4>
                    ${scenarioData.setup_instructions.map(step => `<p style="margin: 2px 0; font-size: 14px;">${step}</p>`).join('')}
                </div>
                
                <div class="feedback-item">
                    <h4>‚öôÔ∏è Configuration Notes</h4>
                    <pre style="white-space: pre-wrap; font-size: 12px; background: #f8f9fa; padding: 10px; border-radius: 4px;">${scenarioData.configuration_notes}</pre>
                </div>
                
                <div class="feedback-item">
                    <h4>üß™ Testing Procedures</h4>
                    ${scenarioData.testing_procedures.map(step => `<p style="margin: 2px 0; font-size: 14px;">${step}</p>`).join('')}
                </div>
                
                <div class="feedback-item">
                    <h4>üîß Troubleshooting Guide</h4>
                    <div style="font-size: 14px;">
                        <strong>Common Issues:</strong>
                        ${scenarioData.troubleshooting["Common Issues"].map(issue => `<p style="margin: 2px 0;">${issue}</p>`).join('')}
                        ${Object.keys(scenarioData.troubleshooting["Service-Specific"]).length > 0 ? 
                            `<strong>Service-Specific:</strong>
                            ${Object.entries(scenarioData.troubleshooting["Service-Specific"]).map(([service, issues]) => 
                                `<p><strong>${service}:</strong></p>${issues.map(issue => `<p style="margin: 2px 0 2px 20px;">${issue}</p>`).join('')}`
                            ).join('')}` : ''
                        }
                    </div>
                </div>
            `;
            
            if (requiredKeys.length > 0) {
                feedbackDiv.innerHTML = `
                    <div class="warning">
                        <h4>üîë API Keys & Credentials Required</h4>
                        <p>Please provide the following credentials to complete setup:</p>
                    </div>
                    <div id="keys-container"></div>
                `;
                
                displayKeyInputs();
            } else {
                feedbackDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ No Additional Credentials Required</h4>
                        <p>This scenario uses built-in Make.com features only.</p>
                    </div>
                `;
            }
        }
        
        function displayKeyInputs() {
            const container = document.getElementById('keys-container');
            
            requiredKeys.forEach((keyInfo, index) => {
                const keyDiv = document.createElement('div');
                keyDiv.className = 'feedback-item';
                keyDiv.innerHTML = `
                    <h4>${keyInfo.service} - ${keyInfo.key}</h4>
                    <p>Required for ${keyInfo.service} integration</p>
                    <div class="key-input">
                        <input type="password" 
                               id="key-${index}" 
                               placeholder="Enter your ${keyInfo.key}"
                               onchange="updateKey(${index}, this.value)">
                        <small style="color: #666;">Get this from: ${getKeyInstructions(keyInfo.service, keyInfo.key)}</small>
                    </div>
                `;
                container.appendChild(keyDiv);
            });
        }
        
        function getKeyInstructions(service, key) {
            const instructions = {
                'Gmail': 'Google Cloud Console ‚Üí APIs & Services ‚Üí Credentials',
                'Slack': 'Slack API ‚Üí Your Apps ‚Üí OAuth & Permissions',
                'Google Sheets': 'Google Cloud Console ‚Üí Service Accounts',
                'Twitter': 'Twitter Developer Portal ‚Üí Apps ‚Üí Keys and tokens',
                'OpenWeatherMap': 'OpenWeatherMap ‚Üí API keys'
            };
            return instructions[service] || 'Service documentation';
        }
        
        function updateKey(index, value) {
            requiredKeys[index].value = value;
            requiredKeys[index].configured = value.length > 0;
            saveKeysToLocalStorage();
            
            // Update visual feedback
            const input = document.getElementById(`key-${index}`);
            input.style.borderColor = value.length > 0 ? '#28a745' : '#e1e5e9';
        }
        
        function downloadBlueprint() {
            const configuredKeys = requiredKeys.filter(k => k.configured);
            
            if (configuredKeys.length < requiredKeys.length) {
                const missing = requiredKeys.filter(k => !k.configured);
                alert(`Please configure these keys first: ${missing.map(k => k.service + ' ' + k.key).join(', ')}`);
                return;
            }
            
            // Create enhanced blueprint with user's keys
            const enhancedBlueprint = {
                ...scenarioData,
                user_credentials: requiredKeys,
                generated_at: new Date().toISOString(),
                mobile_configured: true
            };
            
            addLog('Blueprint ready ‚Äì downloading', 'success');
            const blob = new Blob([JSON.stringify(enhancedBlueprint, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ai-generated-scenario.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function startOver() {
            currentStep = 1;
            scenarioData = null;
            requiredKeys = [];
            document.getElementById('description').value = '';
            document.getElementById('results').innerHTML = '';
            document.getElementById('feedback-section').innerHTML = '';
            showStep(1);
        }
        
        function showError(message) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="error">
                    <h4>‚ùå Error</h4>
                    <p>${message}</p>
                </div>
            `;
        }
        
        // Speech-to-text
        function startSpeechRecognition(event) {
            event.preventDefault();
            const btn = event.currentTarget;
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                alert('Speech recognition not supported in this browser');
                return;
            }
            const recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.continuous = false;

            btn.classList.add('active');
            recognition.start();

            recognition.onresult = function(e) {
                const transcript = e.results[0][0].transcript;
                const textarea = document.getElementById('description');
                textarea.value = textarea.value ? textarea.value + ' ' + transcript : transcript;
                btn.classList.remove('active');
            };

            recognition.onerror = function(err) {
                addLog('Speech recognition error: ' + err.message, 'error');
                btn.classList.remove('active');
            };
        }

        // Logging helpers
        function addLog(message, type = 'info') {
            logs.push({ message, type, ts: Date.now() });
            const logContainer = document.getElementById('logContainer');
            logContainer.style.display = 'block';
            const div = document.createElement('div');
            div.className = 'log-item ' + type;
            div.textContent = new Date().toLocaleTimeString() + ' ‚Äì ' + message;
            logContainer.appendChild(div);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Persist keys
        function saveKeysToLocalStorage() {
            localStorage.setItem('storedKeys', JSON.stringify(requiredKeys));
            displayConnectedApps();
        }

        function loadStoredKeys() {
            try {
                const stored = JSON.parse(localStorage.getItem('storedKeys') || '[]');
                stored.forEach(k => k.configured = true);
                return stored;
            } catch (_) {
                return [];
            }
        }

        function displayConnectedApps() {
            const container = document.getElementById('connectedApps');
            if (!container) return;

            const stored = loadStoredKeys().filter(k => k.configured);
            if (stored.length === 0) {
                container.innerHTML = '<em>No stored credentials found.</em>';
                return;
            }

            const byService = {};
            stored.forEach(k => {
                if (!byService[k.service]) byService[k.service] = [];
                byService[k.service].push(k.key);
            });

            let html = '<strong>Connected Apps:</strong><ul>';
            Object.keys(byService).forEach(service => {
                html += `<li>${service}: ${byService[service].join(', ')}</li>`;
            });
            html += '</ul>';
            container.innerHTML = html;
        }
        
        // Initialize
        updateProgress();
        displayConnectedApps();
    </script>
</body>
</html> 